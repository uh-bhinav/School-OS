<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Razorpay Test Payment - School OS</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-initiate {
            background: #667eea;
            color: white;
        }

        .btn-initiate:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-pay {
            background: #10b981;
            color: white;
            grid-column: 1 / -1;
        }

        .btn-pay:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-pay:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #555;
            line-height: 1.6;
        }

        .response-box {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
            color: #333;
        }

        .response-label {
            color: #666;
            font-weight: 600;
            margin-bottom: 10px;
            font-family: sans-serif;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            background: #fee2e2;
            color: #7f1d1d;
            border: 1px solid #fecaca;
        }

        .status.loading {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .hidden {
            display: none;
        }

        .copy-btn {
            background: #6b7280;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .copy-btn:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì School OS - Payment Test</h1>
        <p class="subtitle">Simulate Razorpay payment for testing</p>

                <div class="info-box">
            <strong>üìã Instructions:</strong><br>
            1. Select whether you want to pay for an Invoice or an Order<br>
            2. Enter your backend URL, authentication token, and the corresponding ID<br>
            3. Click "Initiate Payment" to create a Razorpay order<br>
            4. Click "Open Razorpay" to simulate the payment<br>
            5. Use test card: 4111 1111 1111 1111, any future expiry, any CVV
        </div>

        <div class="form-group">
            <label for="backendUrl">Backend URL</label>
            <input type="text" id="backendUrl" value="http://localhost:8000" placeholder="http://localhost:8000">
        </div>

        <div class="form-group">
            <label>Payment Type</label>
            <div style="display: flex; gap: 20px; margin-top: 8px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="paymentType" value="invoice" checked style="width: auto; cursor: pointer;">
                    <span>Invoice</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="paymentType" value="order" style="width: auto; cursor: pointer;">
                    <span>Order</span>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label for="invoiceId">Invoice ID</label>
            <input type="number" id="invoiceId" placeholder="e.g., 105">
        </div>

        <div class="form-group">
            <label for="orderId">Order ID</label>
            <input type="number" id="orderId" placeholder="e.g., 187">
        </div>

        <div class="form-group">
            <label for="token">Auth Token (Bearer)</label>
            <input type="text" id="token" placeholder="Paste your JWT token here">
        </div>

        <div class="button-group">
            <button class="btn-initiate" onclick="initiatePayment()">üöÄ Initiate Payment</button>
            <button class="btn-pay" id="openCheckoutBtn" onclick="openCheckout()" disabled>üí≥ Open Razorpay</button>
        </div>

        <div id="status" class="hidden"></div>

        <div id="responseBox" class="hidden">
            <div class="response-label">üìÑ API Response:</div>
            <pre id="responseContent"></pre>
            <button class="copy-btn" onclick="copyResponse()">üìã Copy Response</button>
        </div>
    </div>

    <script>
        let paymentData = null;
        const backendUrl = () => document.getElementById('backendUrl').value;
        const invoiceId = () => document.getElementById('invoiceId').value;
        const orderId = () => document.getElementById('orderId').value;
        const token = () => document.getElementById('token').value;
        const getPaymentType = () => document.querySelector('input[name="paymentType"]:checked').value;

        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
        }

        function showResponse(data) {
            const responseBox = document.getElementById('responseBox');
            const responseContent = document.getElementById('responseContent');
            responseContent.textContent = JSON.stringify(data, null, 2);
            responseBox.classList.remove('hidden');
        }

        async function initiatePayment() {
            const url = backendUrl();
            const authToken = token();
            const paymentType = getPaymentType();

            if (!url || !authToken) {
                showStatus('‚ùå Please fill in Backend URL and Auth Token', 'error');
                return;
            }

            // Dynamically construct payload based on selected payment type
            let payload;
            if (paymentType === 'invoice') {
                const invoice = invoiceId();
                if (!invoice) {
                    showStatus('‚ùå Please enter an Invoice ID', 'error');
                    return;
                }
                payload = { invoice_id: parseInt(invoice) };
            } else if (paymentType === 'order') {
                const order = orderId();
                if (!order) {
                    showStatus('‚ùå Please enter an Order ID', 'error');
                    return;
                }
                payload = { order_id: parseInt(order) };
            }

            showStatus('‚è≥ Initiating payment...', 'loading');

            try {
                const response = await fetch(`${url}/api/v1/finance/payments/initiate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Payment initiation failed');
                }

                paymentData = data;
                showResponse(data);
                showStatus('‚úÖ Payment initiated successfully! Click "Open Razorpay" to proceed.', 'success');
                document.getElementById('openCheckoutBtn').disabled = false;
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
                console.error('Payment initiation error:', error);
            }
        }

        function openCheckout() {
            if (!paymentData) {
                showStatus('‚ùå Please initiate payment first', 'error');
                return;
            }

            const options = {
                key: paymentData.razorpay_key_id,
                amount: paymentData.amount,
                currency: 'INR',
                name: paymentData.school_name || 'School OS',
                description: paymentData.description || 'Payment for school services',
                order_id: paymentData.razorpay_order_id,
                handler: async function (response) {
                    showStatus('‚è≥ Verifying payment...', 'loading');

                    try {
                        const verifyResponse = await fetch(`${backendUrl()}/api/v1/finance/payments/verify`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token()}`
                            },
                            body: JSON.stringify({
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_signature: response.razorpay_signature,
                                internal_payment_id: paymentData.internal_payment_id
                            })
                        });

                        const verifyData = await verifyResponse.json();

                        if (!verifyResponse.ok) {
                            throw new Error(verifyData.detail || 'Payment verification failed');
                        }

                        showStatus('‚úÖ Payment verified successfully!', 'success');
                        showResponse(verifyData);
                    } catch (error) {
                        showStatus(`‚ùå Verification Error: ${error.message}`, 'error');
                        console.error('Verification error:', error);
                    }
                },
                prefill: {
                    name: '',
                    email: '',
                    contact: ''
                },
                theme: {
                    color: '#667eea'
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        }

        function copyResponse() {
            const responseContent = document.getElementById('responseContent').textContent;
            navigator.clipboard.writeText(responseContent);
            alert('Response copied to clipboard!');
        }
    </script>
</body>
</html>
